<!-- templates/bid_layers/index.html -->
{% extends "base.html" %} {% block title %}Smart Bid Layers - VectorBid{%
endblock %} {% block head %}
<style>
    :root {
        --primary: #3b82f6;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --bg-primary: #f8fafc;
        --bg-secondary: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border: #e2e8f0;
    }

    body {
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .main-header {
        background: white;
        border-bottom: 1px solid var(--border);
        padding: 1.5rem 0;
        margin-bottom: 2rem;
    }

    .layer-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease;
    }

    .layer-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: var(--primary);
    }

    .priority-badge {
        background: var(--primary);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .filter-tag {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        margin: 0.2rem 0.3rem 0.2rem 0;
    }

    .filter-avoid {
        background: #fee2e2;
        color: #dc2626;
    }
    .filter-prefer {
        background: #fef3c7;
        color: #d97706;
    }
    .filter-require {
        background: #ede9fe;
        color: #7c3aed;
    }
    .filter-award {
        background: #d1fae5;
        color: #059669;
    }

    .trip-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .trip-score-badge {
        font-size: 1.2rem;
        font-weight: 700;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        display: inline-block;
    }

    .score-excellent {
        background: #d1fae5;
        color: #065f46;
    }
    .score-good {
        background: #fef3c7;
        color: #92400e;
    }
    .score-fair {
        background: #dbeafe;
        color: #1e40af;
    }
    .score-poor {
        background: #fee2e2;
        color: #991b1b;
    }

    .quick-stats {
        display: flex;
        gap: 2rem;
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid var(--border);
        margin-bottom: 2rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
        display: block;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    .section-tabs {
        background: white;
        border-radius: 12px;
        padding: 0.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border);
    }

    .pbs-code {
        background: #f8fafc;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1.5rem;
        font-family: "Monaco", "Consolas", monospace;
        font-size: 0.9rem;
        line-height: 1.6;
    }

    .section-tabs .nav-link {
        border: none;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        color: var(--text-secondary);
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .section-tabs .nav-link.active {
        background: var(--primary);
        color: white;
    }
</style>
{% endblock %} {% block content %}
<!-- Main Header -->
<div class="main-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="h3 mb-1">
                    <i class="fas fa-layer-group text-primary me-2"></i>
                    Smart Bid Layers
                </h1>
                <p class="text-muted mb-0">
                    Build your perfect bid strategy with intelligent layering
                </p>
            </div>
            <div class="col-md-6 text-md-end">
                <button
                    class="btn btn-primary me-2"
                    onclick="alert('Layer creation modal would open here')"
                >
                    <i class="fas fa-plus me-1"></i>Add Layer
                </button>
                <button class="btn btn-outline-primary" onclick="runAnalysis()">
                    <i class="fas fa-play me-1"></i>Analyze Trips
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="stat-item">
            <span class="stat-number">{{ stats.active_layers }}</span>
            <div class="stat-label">Active Layers</div>
        </div>
        <div class="stat-item">
            <span class="stat-number">{{ stats.trips_analyzed }}</span>
            <div class="stat-label">Trips Analyzed</div>
        </div>
        <div class="stat-item">
            <span class="stat-number">{{ stats.highly_recommended }}</span>
            <div class="stat-label">Highly Recommended</div>
        </div>
        <div class="stat-item">
            <span class="stat-number">
                {% if stats.pbs_ready %}
                <i class="fas fa-check-circle text-success"></i>
                {% else %}
                <i class="fas fa-times-circle text-danger"></i>
                {% endif %}
            </span>
            <div class="stat-label">PBS Ready</div>
        </div>
    </div>

    <!-- Section Navigation -->
    <ul class="nav nav-pills section-tabs" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button
                class="nav-link active"
                id="layers-tab"
                data-bs-toggle="pill"
                data-bs-target="#layers"
                type="button"
                role="tab"
            >
                <i class="fas fa-layer-group me-2"></i>My Layers
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                id="results-tab"
                data-bs-toggle="pill"
                data-bs-target="#results"
                type="button"
                role="tab"
            >
                <i class="fas fa-chart-bar me-2"></i>Trip Results
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                id="pbs-tab"
                data-bs-toggle="pill"
                data-bs-target="#pbs"
                type="button"
                role="tab"
            >
                <i class="fas fa-file-code me-2"></i>PBS Code
            </button>
        </li>
    </ul>

    <div class="tab-content" id="mainTabsContent">
        <!-- Layers Tab -->
        <div class="tab-pane fade show active" id="layers" role="tabpanel">
            <div class="row">
                {% for layer in layers %}
                <div class="col-lg-6 mb-3">
                    <div class="layer-card">
                        <div
                            class="d-flex justify-content-between align-items-start mb-3"
                        >
                            <div class="flex-grow-1">
                                <h3 class="h5 mb-1">{{ layer.name }}</h3>
                                <p class="text-muted mb-0">
                                    {{ layer.description or 'No description' }}
                                </p>
                            </div>
                            <span class="priority-badge"
                                >Priority {{ layer.priority }}</span
                            >
                        </div>

                        <div class="mb-3">
                            {% for filter in layer.filters %}
                            <span
                                class="filter-tag filter-{{ filter.filter_type.lower() }}"
                            >
                                {{ filter.filter_type }}: {{ filter.criteria }}
                            </span>
                            {% endfor %}
                        </div>

                        <div class="d-flex gap-2">
                            <button
                                class="btn btn-sm btn-outline-primary"
                                onclick="alert('Edit layer {{ layer.layer_number }}')"
                            >
                                <i class="fas fa-edit me-1"></i>Edit
                            </button>
                            <button
                                class="btn btn-sm btn-outline-secondary toggle-btn"
                                data-layer="{{ layer.layer_number }}"
                                data-active="{{ layer.is_active|lower }}"
                            >
                                <i
                                    class="fas fa-toggle-{{ 'on' if layer.is_active else 'off' }} me-1"
                                ></i>
                                {{ 'Active' if layer.is_active else 'Inactive'
                                }}
                            </button>
                            <button
                                class="btn btn-sm btn-outline-danger"
                                onclick="deleteLayer({{ layer.layer_number }})"
                            >
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Add Layer Card -->
                <div class="col-lg-6 mb-3">
                    <div
                        class="layer-card"
                        style="
                            border: 2px dashed var(--border);
                            text-align: center;
                            cursor: pointer;
                        "
                        onclick="alert('Add new layer modal would open here')"
                    >
                        <div class="py-4">
                            <i
                                class="fas fa-plus-circle text-primary fa-3x mb-3"
                            ></i>
                            <h4>Add New Layer</h4>
                            <p class="text-muted mb-0">
                                Create another preference layer
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Tab -->
        <div class="tab-pane fade" id="results" role="tabpanel">
            <div class="mb-4">
                <h4>Trip Analysis Results</h4>
                <p class="text-muted">
                    See how your layers scored each available trip
                </p>
            </div>

            {% for trip in evaluated_trips %}
            <div class="trip-card">
                <div class="p-3 border-bottom">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <span
                                    class="trip-score-badge {{ trip.total_score|format_score.class }} me-3"
                                >
                                    {{ trip.total_score|format_score.text }}
                                </span>
                                <div>
                                    <h5 class="mb-1">
                                        Trip {{ trip.trip_id }} - {{
                                        trip.pairing_id }}
                                    </h5>
                                    <p class="text-muted mb-0">
                                        {{ trip.days }} days • {{
                                        trip.credit_hours }} credit hours • {%
                                        if trip.layover_cities %}{{
                                        trip.layover_cities|join(', ') }}
                                        layovers{% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <span
                                class="badge fs-6 px-3 py-2 {{ trip.bid_recommendation|format_recommendation.class }}"
                            >
                                {{
                                trip.bid_recommendation|format_recommendation.text
                                }}
                            </span>
                        </div>
                    </div>
                </div>

                <div
                    class="p-3"
                    id="trip-{{ trip.trip_id }}-details"
                    style="display: none"
                >
                    <h6 class="mb-3">Layer Analysis:</h6>

                    {% for layer_match in trip.layer_matches %}
                    <div
                        class="d-flex align-items-center p-2 mb-2 rounded"
                        style="background: {{ '#f0fdf4' if layer_match.matches else '#fef2f2' }}; 
                                border-left: 4px solid {{ '#10b981' if layer_match.matches else '#ef4444' }};"
                    >
                        <div class="me-3">
                            <i
                                class="fas fa-{{ 'check' if layer_match.matches else 'times' }} 
                               text-{{ 'success' if layer_match.matches else 'danger' }}"
                            ></i>
                        </div>
                        <div class="flex-grow-1">
                            <strong>{{ layer_match.layer_name }}</strong>
                            <div class="small text-muted">
                                {{ layer_match.explanations[0] }}
                            </div>
                        </div>
                        {% if layer_match.matches %}
                        <div class="text-success fw-bold">
                            +{{ layer_match.score }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <div class="px-3 pb-3">
                    <button
                        class="btn btn-sm btn-outline-primary toggle-details"
                        data-trip="{{ trip.trip_id }}"
                    >
                        <i class="fas fa-chevron-down me-1"></i>Show Details
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- PBS Code Tab -->
        <div class="tab-pane fade" id="pbs" role="tabpanel">
            <div class="row">
                <div class="col-md-8">
                    <h4 class="mb-3">Your PBS Bid Code</h4>
                    <p class="text-muted">
                        Copy and paste this into your airline's PBS system
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="btn btn-primary" onclick="copyPBSCode()">
                        <i class="fas fa-copy me-2"></i>Copy Code
                    </button>
                </div>
            </div>

            <div class="pbs-code mt-4" id="pbs-output">{{ pbs_output }}</div>

            <div class="alert alert-info mt-4">
                <i class="fas fa-lightbulb me-2"></i>
                <strong>Next Step:</strong> Log into your crew portal and paste
                this code into your PBS bid. The system generated this based on
                your layer priorities.
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle trip details
    document.querySelectorAll(".toggle-details").forEach((button) => {
        button.addEventListener("click", function () {
            const tripId = this.dataset.trip;
            const details = document.getElementById(`trip-${tripId}-details`);
            const icon = this.querySelector("i");

            if (details.style.display === "none") {
                details.style.display = "block";
                icon.className = "fas fa-chevron-up me-1";
                this.innerHTML =
                    '<i class="fas fa-chevron-up me-1"></i>Hide Details';
            } else {
                details.style.display = "none";
                icon.className = "fas fa-chevron-down me-1";
                this.innerHTML =
                    '<i class="fas fa-chevron-down me-1"></i>Show Details';
            }
        });
    });

    // Toggle layer active status
    document.querySelectorAll(".toggle-btn").forEach((button) => {
        button.addEventListener("click", function () {
            const layerNumber = this.dataset.layer;

            fetch(`/bid-layers/api/layers/${layerNumber}/toggle`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        const newActive = data.is_active;
                        this.dataset.active = newActive;
                        this.innerHTML = `<i class="fas fa-toggle-${newActive ? "on" : "off"} me-1"></i>${newActive ? "Active" : "Inactive"}`;
                        this.className = `btn btn-sm btn-outline-${newActive ? "secondary" : "warning"} toggle-btn`;
                    } else {
                        alert("Error toggling layer: " + data.error);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Error toggling layer");
                });
        });
    });

    function deleteLayer(layerNumber) {
        if (confirm("Are you sure you want to delete this layer?")) {
            fetch(`/bid-layers/api/layers/${layerNumber}`, {
                method: "DELETE",
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert("Error deleting layer: " + data.error);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Error deleting layer");
                });
        }
    }

    function runAnalysis() {
        fetch("/bid-layers/api/analyze", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    const resultsTab = new bootstrap.Tab(
                        document.getElementById("results-tab"),
                    );
                    resultsTab.show();
                } else {
                    alert("Error analyzing trips: " + data.error);
                }
            })
            .catch((error) => {
                console.error("Error:", error);
                alert("Error analyzing trips");
            });
    }

    function copyPBSCode() {
        const code = document.getElementById("pbs-output").textContent;
        navigator.clipboard
            .writeText(code)
            .then(() => {
                const button = event.target.closest("button");
                const original = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
                button.classList.add("btn-success");
                button.classList.remove("btn-primary");

                setTimeout(() => {
                    button.innerHTML = original;
                    button.classList.remove("btn-success");
                    button.classList.add("btn-primary");
                }, 2000);
            })
            .catch((err) => {
                console.error("Failed to copy: ", err);
                alert("Failed to copy PBS code to clipboard");
            });
    }
</script>
{% endblock %}
