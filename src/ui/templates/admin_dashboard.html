<!doctype html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>VectorBid Admin - Bid Package Management</title>
        <link
            href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
            rel="stylesheet"
        />
        <style>
            :root {
                --primary-gradient: linear-gradient(
                    135deg,
                    #667eea 0%,
                    #764ba2 100%
                );
                --success-color: #28a745;
                --danger-color: #dc3545;
                --warning-color: #ffc107;
                --info-color: #17a2b8;
            }

            .admin-header {
                background: var(--primary-gradient);
                color: white;
                padding: 2rem 0;
                margin-bottom: 2rem;
            }

            .card {
                border: none;
                border-radius: 15px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                margin-bottom: 2rem;
            }

            .card-header {
                background: var(--bs-secondary);
                border-radius: 15px 15px 0 0 !important;
                border-bottom: 1px solid var(--bs-border-color);
                padding: 1.5rem;
            }

            .upload-zone {
                border: 2px dashed var(--bs-border-color);
                border-radius: 10px;
                padding: 3rem;
                text-align: center;
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .upload-zone:hover {
                border-color: #667eea;
                background: rgba(102, 126, 234, 0.05);
            }

            .upload-zone.dragover {
                border-color: #667eea;
                background: rgba(102, 126, 234, 0.1);
                transform: scale(1.02);
            }

            .upload-icon {
                font-size: 3rem;
                color: #667eea;
                margin-bottom: 1rem;
            }

            .btn-primary {
                background: var(--primary-gradient);
                border: none;
                border-radius: 8px;
                padding: 0.75rem 1.5rem;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            }

            .stats-card {
                background: var(--bs-body-bg);
                border: 1px solid var(--bs-border-color);
                border-radius: 10px;
                padding: 1.5rem;
                text-align: center;
                transition: all 0.3s ease;
            }

            .stats-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .stats-number {
                font-size: 2rem;
                font-weight: bold;
                color: #667eea;
            }

            .bid-package-item {
                background: var(--bs-body-bg);
                border: 1px solid var(--bs-border-color);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
                display: flex;
                justify-content: between;
                align-items: center;
            }

            .status-badge {
                padding: 0.25rem 0.75rem;
                border-radius: 12px;
                font-size: 0.875rem;
                font-weight: 500;
            }

            .status-active {
                background: var(--success-color);
                color: white;
            }
            .status-processing {
                background: var(--warning-color);
                color: black;
            }
            .status-error {
                background: var(--danger-color);
                color: white;
            }

            .progress-bar {
                background: var(--primary-gradient);
            }

            .alert {
                border-radius: 8px;
                border: none;
                padding: 1rem 1.5rem;
            }

            .log-entry {
                font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
                font-size: 0.875rem;
                background: var(--bs-secondary);
                border-radius: 4px;
                padding: 0.5rem;
                margin-bottom: 0.5rem;
                border-left: 3px solid var(--bs-border-color);
            }

            .log-success {
                border-left-color: var(--success-color);
            }
            .log-error {
                border-left-color: var(--danger-color);
            }
            .log-warning {
                border-left-color: var(--warning-color);
            }

            #fileInput {
                display: none;
            }

            .form-control:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            }
        </style>
    </head>
    <body>
        <!-- Header -->
        <div class="admin-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1><i class="fas fa-cogs me-3"></i>VectorBid Admin</h1>
                        <p class="mb-0">Bid Package Management System</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <span class="badge bg-success">System Online</span>
                        <p class="mb-0 mt-2">
                            <small
                                >Last updated:
                                <span id="lastUpdated">--</span></small
                            >
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Stats Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" id="totalPackages">--</div>
                        <div class="text-muted">Total Packages</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" id="activePackages">--</div>
                        <div class="text-muted">Active This Month</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" id="totalTrips">--</div>
                        <div class="text-muted">Total Trips Parsed</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number" id="activePilots">--</div>
                        <div class="text-muted">Active Pilots</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Upload Section -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-upload me-2"></i>Upload New Bid
                                Package
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="uploadForm">
                                <!-- Month Selection -->
                                <div class="mb-3">
                                    <label class="form-label"
                                        >Bid Month *</label
                                    >
                                    <input
                                        type="month"
                                        class="form-control"
                                        id="bidMonth"
                                        required
                                    />
                                    <div class="form-text">
                                        Select the month this bid package is for
                                    </div>
                                </div>

                                <!-- Airline Selection -->
                                <div class="mb-3">
                                    <label class="form-label">Airline *</label>
                                    <select
                                        class="form-select"
                                        id="airline"
                                        required
                                    >
                                        <option value="">Select airline</option>
                                        <option value="United">
                                            United Airlines
                                        </option>
                                        <option value="Delta">
                                            Delta Air Lines
                                        </option>
                                        <option value="American">
                                            American Airlines
                                        </option>
                                        <option value="Southwest">
                                            Southwest Airlines
                                        </option>
                                        <option value="Alaska">
                                            Alaska Airlines
                                        </option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <!-- Base/Fleet Filter -->
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label"
                                            >Base (Optional)</label
                                        >
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="base"
                                            placeholder="e.g. IAH, DEN"
                                        />
                                        <div class="form-text">
                                            Leave blank for all bases
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label"
                                            >Fleet (Optional)</label
                                        >
                                        <select class="form-select" id="fleet">
                                            <option value="">All fleets</option>
                                            <option value="737">
                                                Boeing 737
                                            </option>
                                            <option value="320">
                                                Airbus A320
                                            </option>
                                            <option value="787">
                                                Boeing 787
                                            </option>
                                            <option value="777">
                                                Boeing 777
                                            </option>
                                            <option value="757/767">
                                                Boeing 757/767
                                            </option>
                                            <option value="Bus">
                                                Airbus A330/350
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <!-- File Upload -->
                                <div class="mb-4">
                                    <label class="form-label"
                                        >Bid Package File *</label
                                    >
                                    <div
                                        class="upload-zone"
                                        onclick="document.getElementById('fileInput').click()"
                                    >
                                        <div class="upload-icon">
                                            <i
                                                class="fas fa-cloud-upload-alt"
                                            ></i>
                                        </div>
                                        <h5>
                                            Drop file here or click to upload
                                        </h5>
                                        <p class="text-muted mb-0">
                                            Supports PDF, CSV, and TXT files up
                                            to 50MB
                                        </p>
                                    </div>
                                    <input
                                        type="file"
                                        id="fileInput"
                                        accept=".pdf,.csv,.txt"
                                        required
                                    />
                                    <div
                                        id="fileInfo"
                                        class="mt-2"
                                        style="display: none"
                                    >
                                        <small class="text-success">
                                            <i
                                                class="fas fa-check-circle me-1"
                                            ></i>
                                            <span id="fileName"></span> (<span
                                                id="fileSize"
                                            ></span
                                            >)
                                        </small>
                                    </div>
                                </div>

                                <!-- Upload Progress -->
                                <div
                                    id="uploadProgress"
                                    class="mb-3"
                                    style="display: none"
                                >
                                    <div
                                        class="d-flex justify-content-between mb-1"
                                    >
                                        <span>Uploading...</span>
                                        <span id="progressPercent">0%</span>
                                    </div>
                                    <div class="progress">
                                        <div
                                            class="progress-bar"
                                            id="progressBar"
                                            style="width: 0%"
                                        ></div>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <button
                                    type="submit"
                                    class="btn btn-primary btn-lg w-100"
                                    id="uploadBtn"
                                >
                                    <i class="fas fa-upload me-2"></i>Upload Bid
                                    Package
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Processing Log -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-terminal me-2"></i>Processing
                                Log
                            </h5>
                        </div>
                        <div class="card-body">
                            <div
                                id="processingLog"
                                style="max-height: 200px; overflow-y: auto"
                            >
                                <div class="log-entry">
                                    <i class="fas fa-info-circle me-2"></i>Admin
                                    dashboard loaded
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bid Packages List -->
                <div class="col-lg-6">
                    <div class="card">
                        <div
                            class="card-header d-flex justify-content-between align-items-center"
                        >
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>Recent Bid
                                Packages
                            </h5>
                            <button
                                class="btn btn-outline-secondary btn-sm"
                                onclick="refreshPackages()"
                            >
                                <i class="fas fa-sync-alt me-1"></i>Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="bidPackagesList">
                                <!-- Packages will be loaded here -->
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-box-open fa-2x mb-2"></i>
                                    <p>Loading bid packages...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-bolt me-2"></i>Quick Actions
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button
                                    class="btn btn-outline-primary"
                                    onclick="testParser()"
                                >
                                    <i class="fas fa-flask me-2"></i>Test Parser
                                </button>
                                <button
                                    class="btn btn-outline-info"
                                    onclick="viewLogs()"
                                >
                                    <i class="fas fa-file-alt me-2"></i>View
                                    System Logs
                                </button>
                                <button
                                    class="btn btn-outline-warning"
                                    onclick="clearCache()"
                                >
                                    <i class="fas fa-trash-alt me-2"></i>Clear
                                    Cache
                                </button>
                                <button
                                    class="btn btn-outline-success"
                                    onclick="exportData()"
                                >
                                    <i class="fas fa-download me-2"></i>Export
                                    Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Modal -->
        <div class="modal fade" id="successModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-check-circle me-2"></i>Upload
                            Successful
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <div id="successMessage"></div>
                    </div>
                    <div class="modal-footer">
                        <button
                            type="button"
                            class="btn btn-success"
                            data-bs-dismiss="modal"
                        >
                            OK
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Global variables
            let adminToken = localStorage.getItem("adminToken");

            // Initialize page
            document.addEventListener("DOMContentLoaded", function () {
                initializePage();
                setupEventListeners();
                loadStats();
                loadBidPackages();
                setDefaultMonth();
            });

            function initializePage() {
                // Check for admin token
                if (!adminToken) {
                    adminToken = prompt("Enter admin token:");
                    if (adminToken) {
                        localStorage.setItem("adminToken", adminToken);
                    } else {
                        alert("Admin token required");
                        return;
                    }
                }

                updateLastUpdated();
                addLogEntry("info", "Admin dashboard initialized");
            }

            function setupEventListeners() {
                // File input handler
                document
                    .getElementById("fileInput")
                    .addEventListener("change", handleFileSelect);

                // Upload form handler
                document
                    .getElementById("uploadForm")
                    .addEventListener("submit", handleUpload);

                // Drag and drop handlers
                const uploadZone = document.querySelector(".upload-zone");
                uploadZone.addEventListener("dragover", handleDragOver);
                uploadZone.addEventListener("dragleave", handleDragLeave);
                uploadZone.addEventListener("drop", handleDrop);
            }

            function setDefaultMonth() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, "0");
                document.getElementById("bidMonth").value = `${year}-${month}`;
            }

            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    displayFileInfo(file);
                }
            }

            function displayFileInfo(file) {
                const fileInfo = document.getElementById("fileInfo");
                const fileName = document.getElementById("fileName");
                const fileSize = document.getElementById("fileSize");

                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.style.display = "block";
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return "0 Bytes";
                const k = 1024;
                const sizes = ["Bytes", "KB", "MB", "GB"];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return (
                    parseFloat((bytes / Math.pow(k, i)).toFixed(2)) +
                    " " +
                    sizes[i]
                );
            }

            function handleDragOver(event) {
                event.preventDefault();
                event.currentTarget.classList.add("dragover");
            }

            function handleDragLeave(event) {
                event.currentTarget.classList.remove("dragover");
            }

            function handleDrop(event) {
                event.preventDefault();
                event.currentTarget.classList.remove("dragover");

                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    const fileInput = document.getElementById("fileInput");
                    fileInput.files = files;
                    displayFileInfo(files[0]);
                }
            }

            async function handleUpload(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData();

                // Get form values
                const bidMonth = document.getElementById("bidMonth").value;
                const airline = document.getElementById("airline").value;
                const base = document.getElementById("base").value;
                const fleet = document.getElementById("fleet").value;
                const file = document.getElementById("fileInput").files[0];

                if (!file) {
                    alert("Please select a file to upload");
                    return;
                }

                // Create month tag (YYYYMM)
                const monthTag = bidMonth.replace("-", "");

                // Prepare form data
                formData.append("month_tag", monthTag);
                formData.append("file", file);
                formData.append("airline", airline);
                if (base) formData.append("base", base);
                if (fleet) formData.append("fleet", fleet);

                try {
                    showUploadProgress();
                    addLogEntry(
                        "info",
                        `Starting upload: ${file.name} for ${bidMonth}`,
                    );

                    const response = await fetch("/admin/upload-bid", {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${adminToken}`,
                        },
                        body: formData,
                    });

                    if (response.ok) {
                        const result = await response.json();
                        handleUploadSuccess(result, file.name, bidMonth);
                    } else {
                        throw new Error(
                            `Upload failed: ${response.status} ${response.statusText}`,
                        );
                    }
                } catch (error) {
                    handleUploadError(error);
                } finally {
                    hideUploadProgress();
                }
            }

            function showUploadProgress() {
                document.getElementById("uploadProgress").style.display =
                    "block";
                document.getElementById("uploadBtn").disabled = true;

                // Simulate progress (in real implementation, use xhr.upload.onprogress)
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress >= 95) {
                        clearInterval(interval);
                        progress = 95;
                    }
                    updateProgress(progress);
                }, 200);
            }

            function updateProgress(percent) {
                const progressBar = document.getElementById("progressBar");
                const progressPercent =
                    document.getElementById("progressPercent");

                progressBar.style.width = `${percent}%`;
                progressPercent.textContent = `${Math.round(percent)}%`;
            }

            function hideUploadProgress() {
                setTimeout(() => {
                    document.getElementById("uploadProgress").style.display =
                        "none";
                    document.getElementById("uploadBtn").disabled = false;
                    updateProgress(0);
                }, 1000);
            }

            function handleUploadSuccess(result, fileName, bidMonth) {
                updateProgress(100);
                addLogEntry(
                    "success",
                    `Upload successful: ${fileName} processed for ${bidMonth}`,
                );

                // Show success modal
                document.getElementById("successMessage").innerHTML = `
                <p><strong>File:</strong> ${fileName}</p>
                <p><strong>Month:</strong> ${bidMonth}</p>
                <p><strong>Status:</strong> ${result.status}</p>
                <p><strong>Stored ID:</strong> ${result.stored}</p>
            `;

                const modal = new bootstrap.Modal(
                    document.getElementById("successModal"),
                );
                modal.show();

                // Reset form
                document.getElementById("uploadForm").reset();
                document.getElementById("fileInfo").style.display = "none";
                setDefaultMonth();

                // Refresh data
                loadStats();
                loadBidPackages();
            }

            function handleUploadError(error) {
                console.error("Upload error:", error);
                addLogEntry("error", `Upload failed: ${error.message}`);
                alert(`Upload failed: ${error.message}`);
            }

            function addLogEntry(type, message) {
                const log = document.getElementById("processingLog");
                const timestamp = new Date().toLocaleTimeString();

                const logClass =
                    type === "success"
                        ? "log-success"
                        : type === "error"
                          ? "log-error"
                          : type === "warning"
                            ? "log-warning"
                            : "";

                const icon =
                    type === "success"
                        ? "check-circle"
                        : type === "error"
                          ? "exclamation-triangle"
                          : type === "warning"
                            ? "exclamation-circle"
                            : "info-circle";

                const entry = document.createElement("div");
                entry.className = `log-entry ${logClass}`;
                entry.innerHTML = `
                <i class="fas fa-${icon} me-2"></i>
                <span class="text-muted">[${timestamp}]</span> ${message}
            `;

                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            }

            function updateLastUpdated() {
                document.getElementById("lastUpdated").textContent =
                    new Date().toLocaleString();
            }

            async function loadStats() {
                // Simulate loading stats (replace with real API calls)
                setTimeout(() => {
                    document.getElementById("totalPackages").textContent = "12";
                    document.getElementById("activePackages").textContent = "3";
                    document.getElementById("totalTrips").textContent = "1,247";
                    document.getElementById("activePilots").textContent = "89";
                }, 500);
            }

            async function loadBidPackages() {
                // Simulate loading packages (replace with real API call)
                const packagesHtml = `
                <div class="bid-package-item">
                    <div>
                        <h6 class="mb-1">December 2024 - United Airlines</h6>
                        <small class="text-muted">Uploaded 2 days ago • 156 trips</small>
                    </div>
                    <span class="status-badge status-active">Active</span>
                </div>
                <div class="bid-package-item">
                    <div>
                        <h6 class="mb-1">November 2024 - United Airlines</h6>
                        <small class="text-muted">Uploaded 1 week ago • 142 trips</small>
                    </div>
                    <span class="status-badge status-active">Active</span>
                </div>
                <div class="bid-package-item">
                    <div>
                        <h6 class="mb-1">October 2024 - Delta Airlines</h6>
                        <small class="text-muted">Uploaded 1 month ago • 178 trips</small>
                    </div>
                    <span class="status-badge status-active">Active</span>
                </div>
            `;

                setTimeout(() => {
                    document.getElementById("bidPackagesList").innerHTML =
                        packagesHtml;
                }, 300);
            }

            function refreshPackages() {
                addLogEntry("info", "Refreshing bid packages list...");
                loadBidPackages();
                loadStats();
            }

            function testParser() {
                addLogEntry("info", "Running parser test...");
                // Simulate test
                setTimeout(() => {
                    addLogEntry(
                        "success",
                        "Parser test completed successfully",
                    );
                }, 1000);
            }

            function viewLogs() {
                addLogEntry("info", "Opening system logs...");
                // Implement log viewer
            }

            function clearCache() {
                if (confirm("Are you sure you want to clear the cache?")) {
                    addLogEntry("warning", "Cache cleared");
                }
            }

            function exportData() {
                addLogEntry("info", "Preparing data export...");
                // Implement data export
            }
        </script>
    </body>
</html>
