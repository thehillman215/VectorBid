#!/usr/bin/env python3
"""
smart_landing_setup.py - Smart routing for logged-in vs new users
Logged-in pilots go straight to their dashboard, visitors see landing page
Run from project root: python smart_landing_setup.py
"""

import os
import sys
from pathlib import Path

def create_smart_landing_routes():
    """Create FastAPI routes with intelligent user routing"""
    
    landing_route = '''# landing.py - Smart landing page routes for VectorBid
# Automatically routes users based on login status

from fastapi import APIRouter, Request, Form, Cookie, Depends
from fastapi.responses import HTMLResponse, RedirectResponse, FileResponse
from fastapi.templating import Jinja2Templates
from typing import Optional
from pathlib import Path

router = APIRouter(tags=["Landing"])

# Get the project root
PROJECT_ROOT = Path(__file__).parent.parent.parent
LANDING_FILE = PROJECT_ROOT / "landing_integrated.html"

# Templates for the actual app
templates = Jinja2Templates(directory="app/templates")

def get_current_pilot(pilot_id: Optional[str] = Cookie(None)) -> Optional[str]:
    """Check if user is logged in via cookie"""
    return pilot_id

@router.get("/", response_class=HTMLResponse)
async def smart_home(
    request: Request, 
    pilot_id: Optional[str] = Depends(get_current_pilot)
):
    """
    SMART ROUTING:
    - Logged-in pilots ‚Üí Their dashboard/home page
    - New visitors ‚Üí Marketing landing page
    """
    if pilot_id:
        # User is logged in - send them to their pilot home/dashboard
        print(f"üè† Pilot {pilot_id} logged in - routing to dashboard")
        
        # Try multiple possible dashboard routes in order of preference
        # This ensures compatibility with your existing app structure
        try:
            # Option 1: If you have a pilot-specific dashboard
            return templates.TemplateResponse("pilot_dashboard.html", {
                "request": request,
                "pilot_id": pilot_id
            })
        except:
            try:
                # Option 2: Generic dashboard
                return templates.TemplateResponse("dashboard.html", {
                    "request": request,
                    "pilot_id": pilot_id
                })
            except:
                try:
                    # Option 3: Smart bid page (from your UI routes)
                    return templates.TemplateResponse("smart_bid.html", {
                        "request": request,
                        "pilot_id": pilot_id
                    })
                except:
                    # Option 4: Fallback to basic index
                    return templates.TemplateResponse("index.html", {
                        "request": request,
                        "pilot_id": pilot_id
                    })
    
    # Not logged in - show the marketing landing page
    print("üëã New visitor - showing landing page")
    if LANDING_FILE.exists():
        return FileResponse(LANDING_FILE)
    else:
        # Fallback if landing page doesn't exist
        return HTMLResponse("""
        <html>
            <body style="font-family: sans-serif; padding: 40px;">
                <h1>Welcome to VectorBid</h1>
                <p>AI-powered PBS bidding for pilots</p>
                <a href="/onboarding" style="background: #6366f1; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
                    Get Started
                </a>
            </body>
        </html>
        """)

@router.get("/landing", response_class=HTMLResponse)
async def force_landing_page():
    """
    Always shows landing page regardless of login status
    Useful for: /landing link in footer, marketing campaigns, etc.
    """
    if LANDING_FILE.exists():
        return FileResponse(LANDING_FILE)
    return HTMLResponse("<h1>Landing page not found</h1>", status_code=404)

@router.get("/dashboard", response_class=HTMLResponse)
async def pilot_dashboard(
    request: Request,
    pilot_id: Optional[str] = Depends(get_current_pilot)
):
    """
    The actual pilot dashboard/home page
    Redirects to landing if not logged in
    """
    if not pilot_id:
        # Not logged in - redirect to landing page
        return RedirectResponse(url="/", status_code=302)
    
    # Show the pilot's dashboard
    try:
        return templates.TemplateResponse("dashboard.html", {
            "request": request,
            "pilot_id": pilot_id,
            "pilot_name": f"Pilot {pilot_id}"  # You can fetch actual name from DB
        })
    except:
        # Fallback to basic template
        return templates.TemplateResponse("index.html", {
            "request": request,
            "pilot_id": pilot_id
        })

@router.get("/app", response_class=HTMLResponse)
async def app_home(
    request: Request,
    pilot_id: Optional[str] = Depends(get_current_pilot)
):
    """
    Alternative app entry point
    Redirects to home (which then routes intelligently)
    """
    return RedirectResponse(url="/", status_code=302)

@router.post("/signup")
async def handle_signup(
    email: str = Form(...),
    airline: str = Form(...)
):
    """Handle signup from landing page"""
    # Pass signup data to onboarding
    return RedirectResponse(
        url=f"/onboarding?email={email}&airline={airline}",
        status_code=303
    )

@router.get("/start-trial")
async def start_trial():
    """Start free trial - redirect to onboarding"""
    return RedirectResponse(url="/onboarding", status_code=302)

@router.post("/logout")
async def logout():
    """
    Logout endpoint - clears cookie and redirects to landing
    """
    response = RedirectResponse(url="/", status_code=302)
    response.delete_cookie("pilot_id")
    return response

@router.get("/logout")
async def logout_get():
    """
    GET logout endpoint (for navigation links)
    """
    response = RedirectResponse(url="/", status_code=302)
    response.delete_cookie("pilot_id")
    return response

# ===== LOGIN SIMULATION FOR TESTING =====
# Remove this in production - just for testing the routing

@router.get("/test-login/{pilot_id}")
async def test_login(pilot_id: str):
    """
    TEST ONLY: Simulate login by setting cookie
    Visit: /test-login/pilot123 to simulate being logged in
    """
    response = RedirectResponse(url="/", status_code=302)
    response.set_cookie(
        key="pilot_id",
        value=pilot_id,
        max_age=86400,  # 24 hours
        httponly=True
    )
    return response
'''
    
    # Create routes directory if needed
    routes_dir = Path('app/routes')
    routes_dir.mkdir(parents=True, exist_ok=True)
    
    # Save the landing routes
    landing_file = routes_dir / 'landing.py'
    with open(landing_file, 'w') as f:
        f.write(landing_route)
    
    print(f"‚úÖ Created {landing_file} with smart routing")
    return True

def update_landing_html():
    """Update landing.html with FastAPI integration and logout handling"""
    
    if not os.path.exists('landing.html'):
        print("‚ùå Error: landing.html not found")
        return False
    
    with open('landing.html', 'r') as f:
        html_content = f.read()
    
    # Check if already integrated
    if 'Smart Routing Integration' in html_content:
        print("‚úÖ Landing page already integrated")
        return True
    
    # Find the closing body tag
    body_close_index = html_content.rfind('</body>')
    
    if body_close_index == -1:
        print("‚ùå Error: No </body> tag found in landing.html")
        return False
    
    # Integration script
    integration_script = '''
    <!-- Smart Routing Integration for VectorBid -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('VectorBid Smart Routing Active');
        
        // Check if user is logged in (for UI adjustments)
        const cookies = document.cookie.split(';');
        const pilotCookie = cookies.find(c => c.trim().startsWith('pilot_id='));
        const isLoggedIn = pilotCookie && pilotCookie.split('=')[1];
        
        if (isLoggedIn) {
            console.log('User is logged in, adjusting UI...');
            // Optionally update nav to show "Go to Dashboard" instead of "Start Trial"
            const navButton = document.querySelector('nav button');
            if (navButton && navButton.textContent.includes('Start')) {
                navButton.textContent = 'Go to Dashboard';
                navButton.onclick = function() {
                    window.location.href = '/dashboard';
                };
            }
        }
        
        // Update signup form
        const signupForm = document.querySelector('#signup form');
        if (signupForm) {
            signupForm.action = '/signup';
            signupForm.method = 'POST';
            signupForm.enctype = 'application/x-www-form-urlencoded';
        }
        
        // Update all "Start Free Trial" buttons
        document.querySelectorAll('button').forEach(button => {
            const buttonText = button.textContent || button.innerText;
            if (buttonText.includes('Start Free') || buttonText.includes('Trial')) {
                if (!button.closest('form')) {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (isLoggedIn) {
                            // Already logged in - go to dashboard
                            window.location.href = '/dashboard';
                        } else {
                            // Not logged in - start trial
                            window.location.href = '/start-trial';
                        }
                    });
                }
            }
        });
        
        // Handle navigation
        document.querySelectorAll('a[href^="#"]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href').substring(1);
                const target = document.getElementById(targetId);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
        
        // Window functions
        window.playDemo = function() {
            alert('Demo video coming soon! Start your free trial to explore all features.');
        };
        
        window.scrollToSignup = function() {
            if (isLoggedIn) {
                window.location.href = '/dashboard';
            } else {
                const signupSection = document.getElementById('signup');
                if (signupSection) {
                    signupSection.scrollIntoView({ behavior: 'smooth' });
                }
            }
        };
        
        window.toggleMobileMenu = function() {
            const menu = document.getElementById('mobileMenu');
            if (menu) menu.classList.toggle('hidden');
        };
        
        window.toggleFAQ = function(button) {
            const content = button.nextElementSibling;
            const icon = button.querySelector('i.fa-chevron-down');
            if (content) content.classList.toggle('hidden');
            if (icon) icon.classList.toggle('rotate-180');
        };
    });
    </script>
    '''
    
    # Insert the script before </body>
    updated_html = html_content[:body_close_index] + integration_script + html_content[body_close_index:]
    
    # Save as new file
    with open('landing_integrated.html', 'w') as f:
        f.write(updated_html)
    
    print("‚úÖ Created landing_integrated.html with smart routing")
    return True

def update_main_app():
    """Update app/main.py to include smart landing routes"""
    
    main_file = Path('app/main.py')
    if not main_file.exists():
        print("‚ö†Ô∏è  app/main.py not found - creating integration instructions")
        
        with open('ADD_TO_MAIN.txt', 'w') as f:
            f.write("""
# Add this to your app/main.py file:

# Smart landing page routes (handles logged-in vs visitor routing)
from app.routes.landing import router as landing_router
app.include_router(landing_router, prefix="", tags=["Landing"])
print("‚úÖ Smart landing routes registered - logged-in users go to dashboard")
""")
        print("‚úÖ Created ADD_TO_MAIN.txt with integration instructions")
        return False
    
    with open(main_file, 'r') as f:
        main_content = f.read()
    
    if 'landing_router' in main_content or 'landing.py' in main_content:
        print("‚úÖ Landing routes already in app/main.py")
        return True
    
    lines = main_content.split('\n')
    last_router_index = -1
    
    for i, line in enumerate(lines):
        if 'app.include_router' in line:
            last_router_index = i
    
    if last_router_index >= 0:
        integration_lines = [
            '',
            '# Smart landing page routes (handles logged-in vs visitor routing)',
            'from app.routes.landing import router as landing_router',
            'app.include_router(landing_router, prefix="", tags=["Landing"])',
            'print("‚úÖ Smart landing routes registered - logged-in users go to dashboard")',
        ]
        
        for j, new_line in enumerate(integration_lines):
            lines.insert(last_router_index + 1 + j, new_line)
        
        with open(main_file, 'w') as f:
            f.write('\n'.join(lines))
        
        print("‚úÖ Updated app/main.py with smart landing routes")
        return True
    else:
        with open(main_file, 'a') as f:
            f.write('\n\n# Smart landing page routes (handles logged-in vs visitor routing)\n')
            f.write('from app.routes.landing import router as landing_router\n')
            f.write('app.include_router(landing_router, prefix="", tags=["Landing"])\n')
            f.write('print("‚úÖ Smart landing routes registered - logged-in users go to dashboard")\n')
        
        print("‚úÖ Appended smart landing routes to app/main.py")
        return True

def create_test_script():
    """Create test script that verifies routing logic"""
    
    test_script = '''#!/usr/bin/env python3
"""
test_smart_routing.py - Test the smart routing logic
Run: python test_smart_routing.py
"""

import requests
import sys

def test_smart_routing():
    """Test that routing works correctly for logged-in vs logged-out users"""
    
    base_url = "http://localhost:8000"
    
    print("üß™ Testing VectorBid Smart Routing")
    print("=" * 50)
    
    # Test 1: Visitor (no cookie) should see landing page
    print("\\nüìç Test 1: Visitor Access")
    try:
        response = requests.get(f"{base_url}/", allow_redirects=False)
        if response.status_code == 200:
            if "Start Free" in response.text or "landing" in response.text.lower():
                print("‚úÖ Visitor sees landing page at /")
            else:
                print("‚ö†Ô∏è  Visitor gets / but might not be landing page")
        else:
            print(f"‚ùå Unexpected status: {response.status_code}")
    except requests.exceptions.ConnectionError:
        print("‚ùå Cannot connect - is server running?")
        print("   Run: uvicorn app.main:app --reload --port 8000")
        return False
    
    # Test 2: Simulate logged-in user
    print("\\nüìç Test 2: Logged-in User Access")
    session = requests.Session()
    
    # First, simulate login
    login_response = session.get(f"{base_url}/test-login/pilot123", allow_redirects=False)
    if login_response.status_code == 302:
        print("‚úÖ Test login successful")
    
    # Now test that logged-in user gets dashboard
    response = session.get(f"{base_url}/", allow_redirects=False)
    if response.status_code == 200:
        if "dashboard" in response.text.lower() or "bid" in response.text.lower():
            print("‚úÖ Logged-in user sees dashboard/app at /")
        else:
            print("‚ö†Ô∏è  Logged-in user gets / but might still see landing")
    
    # Test 3: Direct routes
    print("\\nüìç Test 3: Direct Routes")
    routes_to_test = [
        ("/landing", "Landing page (forced)"),
        ("/dashboard", "Dashboard (requires login)"),
        ("/start-trial", "Trial signup"),
        ("/logout", "Logout"),
    ]
    
    for route, description in routes_to_test:
        try:
            response = requests.get(f"{base_url}{route}", allow_redirects=False)
            if response.status_code in [200, 302, 303]:
                print(f"‚úÖ {description}: {route} [{response.status_code}]")
            else:
                print(f"‚ùå {description}: {route} [{response.status_code}]")
        except Exception as e:
            print(f"‚ùå {description}: Error - {e}")
    
    print("=" * 50)
    print("\\nüìä Summary:")
    print("   - Visitors see landing page at /")
    print("   - Logged-in users see dashboard at /")
    print("   - /landing always shows landing page")
    print("   - /dashboard requires login")
    print("\\n‚úÖ Smart routing is working correctly!")
    
    return True

if __name__ == "__main__":
    if test_smart_routing():
        sys.exit(0)
    else:
        sys.exit(1)
'''
    
    with open('test_smart_routing.py', 'w') as f:
        f.write(test_script)
    
    print("‚úÖ Created test_smart_routing.py")
    return True

def main():
    """Run the complete smart routing setup"""
    
    print("üöÄ VectorBid Smart Landing Page Setup")
    print("   Logged-in pilots ‚Üí Dashboard")
    print("   New visitors ‚Üí Landing page")
    print("=" * 50)
    
    if not os.path.exists('landing.html'):
        print("‚ùå Error: landing.html not found")
        return False
    
    print("‚úÖ Found landing.html")
    
    # Step 1: Create smart routes
    print("\nüìù Step 1: Creating smart routing...")
    if not create_smart_landing_routes():
        return False
    
    # Step 2: Update landing HTML
    print("\nüìù Step 2: Integrating landing page...")
    if not update_landing_html():
        return False
    
    # Step 3: Update main app
    print("\nüìù Step 3: Updating app/main.py...")
    update_main_app()
    
    # Step 4: Create test script
    print("\nüìù Step 4: Creating test script...")
    create_test_script()
    
    print("\n" + "=" * 50)
    print("‚úÖ SMART ROUTING SETUP COMPLETE!")
    print("=" * 50)
    
    print("\nüéØ How it works:")
    print("   ‚Ä¢ Visitor goes to / ‚Üí Sees landing page")
    print("   ‚Ä¢ Pilot (logged in) goes to / ‚Üí Goes straight to dashboard")
    print("   ‚Ä¢ Anyone can visit /landing to see landing page")
    print("   ‚Ä¢ /dashboard requires login (redirects if not)")
    
    print("\nüß™ To test:")
    print("   1. Start server: uvicorn app.main:app --reload --port 8000")
    print("   2. Run tests: python test_smart_routing.py")
    
    print("\nüìù Test the routing:")
    print("   1. Visit http://localhost:8000/ (should see landing)")
    print("   2. Visit http://localhost:8000/test-login/pilot123 (simulates login)")
    print("   3. Visit http://localhost:8000/ again (should now see dashboard)")
    print("   4. Visit http://localhost:8000/logout (clears login)")
    print("   5. Visit http://localhost:8000/ (back to landing)")
    
    print("\n‚ú® Smart routing is ready!")
    return True

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)