<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VectorBid Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark">
      <div class="container-fluid">
        <span class="navbar-brand">VectorBid Admin</span>
        <div>
          <a class="btn btn-sm btn-outline-light" href="{{ url_for('admin.manage_users') }}">Users</a>
          <a class="btn btn-sm btn-outline-light" href="{{ url_for('admin.view_logs') }}">Logs</a>
          <a class="btn btn-sm btn-danger" href="{{ url_for('admin.logout') }}">Logout</a>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row text-center mb-4">
        <div class="col">Packets: <strong>{{ packets|length }}</strong></div>
        <div class="col">Storage: <strong>{{ storage_mb }} MB</strong></div>
        <div class="col">Airlines: <strong>{{ unique_airlines }}</strong></div>
        <div class="col">Uploads: <strong>{{ metrics.uploads }}</strong> | Deletes: <strong>{{ metrics.deletes }}</strong></div>
      </div>

      <h5>Upload Bid Packet</h5>
      <form id="bidForm" class="row g-2" enctype="multipart/form-data">
        <div class="col-md-3">
          <input class="form-control" id="month_tag" name="month_tag" placeholder="YYYYMM" pattern="\d{6}" required>
        </div>
        <div class="col-md-3">
          <input class="form-control" id="airline" name="airline" placeholder="Airline" required>
        </div>
        <div class="col-md-4">
          <input class="form-control" type="file" id="bid_file" name="file" accept=".pdf" required>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" id="bidUploadBtn" disabled>Upload</button>
        </div>
      </form>

      <h5 class="mt-4">Bid Packets</h5>
      <table class="table table-sm" id="packetTable">
        <thead><tr><th>Airline</th><th>Month</th><th>Filename</th><th>Size</th><th></th></tr></thead>
        <tbody>
          {% for p in packets %}
          <tr>
            <td>{{ p.airline }}</td>
            <td>{{ p.month_tag }}</td>
            <td>{{ p.filename }}</td>
            <td>{{ p.size_mb }} MB</td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="deletePacket('{{ p.month_tag }}','{{ p.airline }}')">Delete</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <h5 class="mt-4">Upload Contract</h5>
      <form id="contractForm" class="row g-2" enctype="multipart/form-data">
        <div class="col-md-4">
          <input class="form-control" id="contract_airline" name="airline" placeholder="Airline" required>
        </div>
        <div class="col-md-4">
          <input class="form-control" id="contract_version" name="version" placeholder="Version">
        </div>
        <div class="col-md-2">
          <input class="form-control" type="file" id="contract_file" name="file" accept=".pdf" required>
        </div>
        <div class="col-md-2">
          <button class="btn btn-success w-100" id="contractUploadBtn" disabled>Upload</button>
        </div>
      </form>

      <h5 class="mt-4">Contracts</h5>
      <table class="table table-sm" id="contractTable">
        <thead><tr><th>Filename</th><th>Size</th><th></th></tr></thead>
        <tbody>
          {% for c in contracts %}
          <tr>
            <td>{{ c.filename }}</td>
            <td>{{ c.size_mb }} MB</td>
            <td><button class="btn btn-sm btn-danger" onclick="deleteContract('{{ c.filename }}')">Delete</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const allowedExtensions = {{ allowed_extensions|tojson }};
      function showToast(message, type) {
        const container = document.getElementById('toastContainer');
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-bg-${type} border-0`;
        toastEl.role = 'alert';
        toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        container.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
      }
      function validateBidForm(){
        const m = document.getElementById('month_tag').value;
        const a = document.getElementById('airline').value;
        const f = document.getElementById('bid_file').files.length>0;
        document.getElementById('bidUploadBtn').disabled = !(m.match(/^\d{6}$/) && a && f);
      }
      document.getElementById('bidForm').addEventListener('input', validateBidForm);
      document.getElementById('bidForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const file = document.getElementById('bid_file').files[0];
        const ext = file.name.split('.').pop().toLowerCase();
        if(!allowedExtensions.includes(ext)){showToast('Invalid file type','danger');return;}
        const fd = new FormData(e.target);
        const res = await fetch('/admin/api/upload-bid-packet',{method:'POST',body:fd});
        const data = await res.json();
        if(res.ok && data.success){showToast('Upload successful','success'); setTimeout(()=>location.reload(),800);} else {showToast(data.error||'Upload failed','danger');}
      });
      function deletePacket(month, airline){
        fetch(`/admin/api/delete-bid-packet/${month}/${airline}`,{method:'DELETE'})
          .then(r=>r.json()).then(d=>{if(d.success){showToast('Deleted','success');setTimeout(()=>location.reload(),800);}else{showToast(d.error,'danger');}});
      }
      function validateContractForm(){
        const a=document.getElementById('contract_airline').value;
        const f=document.getElementById('contract_file').files.length>0;
        document.getElementById('contractUploadBtn').disabled = !(a && f);
      }
      document.getElementById('contractForm').addEventListener('input', validateContractForm);
      document.getElementById('contractForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const file=document.getElementById('contract_file').files[0];
        const ext=file.name.split('.').pop().toLowerCase();
        if(!allowedExtensions.includes(ext)){showToast('Invalid file type','danger');return;}
        const fd=new FormData(e.target);
        const res=await fetch('/admin/api/upload-contract',{method:'POST',body:fd});
        const data=await res.json();
        if(res.ok && data.success){showToast('Contract uploaded','success');setTimeout(()=>location.reload(),800);}else{showToast(data.error||'Upload failed','danger');}
      });
      function deleteContract(name){
        fetch(`/admin/api/delete-contract/${name}`,{method:'DELETE'}).then(r=>r.json()).then(d=>{if(d.success){showToast('Contract deleted','success');setTimeout(()=>location.reload(),800);}else{showToast(d.error,'danger');}});
      }
    </script>
  </body>
</html>
